#!/usr/bin/env Rscript
smoothing = 4
folders_to_summarize = paste0('~/Documents/data/quim_aleix/MRIPredict_feps/resultats_raw_feps_mania_servidor/',
                              c('output_feps/only_mri','output_feps/only_data','output_feps/mri_and_data',
                                'output_mania/only_mri','output_mania/only_data','output_mania/mri_and_data',
                                'output_mania_vs_depr/only_mri', 'output_mania_vs_depr/only_data', 'output_mania_vs_depr/mri_and_data'))
# folders_to_summarize = paste0('~/Downloads/resultats_servidor/',
#                               c('output_feps/only_mri','output_feps/only_data','output_feps/mri_and_data',
#                                 'output_mania/only_mri','output_mania/only_data','output_mania/mri_and_data',
#                                 'output_mania_vs_depr/only_mri', 'output_mania_vs_depr/only_data', 'output_mania_vs_depr/mri_and_data'))
#folders_to_summarize = Sys.glob('/home/aleix/Documents/papers_aleix_secure/MRIPredict_feps/resultats_raw_feps_mania/output_trainbern_testfidmag/*/*')
source('../mripredict_limripredict_library.r')
# comencem per crear 3ds de suma de betes
library(oro.nifti)
#template_nifti <- oro.nifti::readNIfTI('etc/sdm_template_2mm.nii.gz')
#template_path = 'etc/sdm_template_2mm.nii.gz'
template_path = '/home/aleix/Documents/dades/feps_totes/gm/subsamp/subsamp/subsamp/s4/0002_gm_subsamp_subsamp_subsamp_s4.nii.gz'
template_nifti <- .read_mri(template_path)
template_nifti_to_write <- readNIfTI(template_path)

calculate_addition_betas <- function(data, img=template_nifti_to_write) {
  # data is an excel 'summary_betas' generated by MRIPredict

  img@.Data <- img_data(img)*0
  for(i in 1:nrow(data)) {
    x = data[i,'ijk_i']; y = data[i,'ijk_j']; z = data[i, 'ijk_k']
    img@.Data[x,y,z] <- img@.Data[x,y,z] + data[i,'betas']
  }
  img
}

# load all summary_beta
library(sys)

files_to_summarize <- Sys.glob(paste0(folders_to_summarize,'/*_betas_summary.csv'))

# per passar a mni la ijk =>  mp$mni = (mri$sto.xyz %*% mp$ijk)[1:3, ]  
# per passar a ijk la mni =>  mp$ijk = (mri$sto.ijk %*% rbind(mni,1))
for (file_to_summarize in files_to_summarize) {
  cat('Analyzing:', file_to_summarize,'\n')
  data_summary <- read.csv(file_to_summarize)
  data_summary <- subset(data_summary, subset = modality != "predictor_variable")
  
  if (nrow(data_summary) > 0 ) {
    data_summary[,c('mni_x','mni_y','mni_z')]=do.call(rbind, strsplit(as.character(data_summary$mni_or_variable), '_'))
    mni <- matrix(as.numeric(rbind(t(data_summary[,c('mni_x','mni_y','mni_z')]),1)),nrow=4)
    data_summary[,c('ijk_i','ijk_j','ijk_k')] <- t(template_nifti$sto.ijk %*% mni)[,1:3] # PER COMPROVAR, MRICRON FLIP L/R AMB VISIÓ RADIOLÒGICA
    
    # agafem les dades de l'excel i les passem a sobre un template 2mm (l'usat a l'SDM-psi)
    data_summary_gm <- subset(data_summary, subset = modality=='gm')
    gm_betes_suma <- calculate_addition_betas(data_summary_gm)
    data_summary_gmmod <- subset(data_summary, subset = modality=='gm_mod')
    gmmod_betes_suma <- calculate_addition_betas(data_summary_gmmod)
    data_summary_wm <- subset(data_summary, subset = modality=='wm')
    wm_betes_suma <- calculate_addition_betas(data_summary_wm)
    data_summary_wmmod <- subset(data_summary, subset = modality=='wm_mod')
    wmmod_betes_suma <- calculate_addition_betas(data_summary_wmmod)
    
    gm_out_path = gsub('.csv','_gm',file_to_summarize)
    gmmod_out_path = gsub('.csv','_gmmod',file_to_summarize)
    wm_out_path = gsub('.csv','_wm',file_to_summarize)
    wmmod_out_path = gsub('.csv','_wmmod',file_to_summarize)

    writeNIfTI(gm_betes_suma, gm_out_path)
    writeNIfTI(gmmod_betes_suma, gmmod_out_path)
    writeNIfTI(wm_betes_suma, wm_out_path)
    writeNIfTI(wmmod_betes_suma, wmmod_out_path)
    
    system(sprintf('fsl5.0-fslmaths %s -s %s %s_s%s', gm_out_path, smoothing, gm_out_path, smoothing))
    system(sprintf('fsl5.0-fslmaths %s -s %s %s_s%s', gmmod_out_path, smoothing, gmmod_out_path, smoothing))
    system(sprintf('fsl5.0-fslmaths %s -s %s %s_s%s', wm_out_path, smoothing, wm_out_path,smoothing))
    system(sprintf('fsl5.0-fslmaths %s -s %s %s_s%s', wmmod_out_path, smoothing, wmmod_out_path, smoothing))
  } else {
    gm_out_path <- gmmod_out_path <- wm_out_path <- wmmod_out_path <- NULL
  }
  # aquí resum de predictores
  data_summary = NULL
  data_summary <- read.csv(file_to_summarize)
  data_summary <- subset(data_summary, subset = modality == "predictor_variable")
  
  if (nrow(data_summary) > 0) {
    variables <- table(data_summary$mni_or_variable)
    variables_summary <- c()
    for (variable in names(variables)){
      variables_summary <- rbind(variables_summary,
                                 data.frame(variable=variable, count=variables[variable], beta_sum=sum(data_summary[data_summary$mni_or_variable==variable,]$betas)))
    }
    write.csv(variables_summary[variables_summary$count>0,], file=gsub('.csv','_predictor_variables.csv',file_to_summarize), row.names = FALSE)
  }
  # aquí resum de predictores i voxels
  data_summary <- NULL
  data_summary <- read.csv(file_to_summarize)
  if (nrow(data_summary) > 0) {
    data_summary$variables <- paste(data_summary$mni_or_variable, data_summary$modality, sep = ':')
    data_summary$variables <- gsub(":predictor_variable", "", data_summary$variables)
    variables <- table(data_summary$variables)
    variables_summary <- c()
    for (variable in names(variables)){
      variables_summary <- rbind(variables_summary,
                                 data.frame(variable=variable, count=variables[variable], beta_sum=sum(data_summary[data_summary$variables==variable,]$betas)))
    }
    write.csv(variables_summary, file=gsub('.csv','_counts_variables_and_voxels.csv',file_to_summarize), row.names = FALSE)
  }
  
}




